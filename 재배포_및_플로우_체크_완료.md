# μ¬λ°°ν¬ λ° ν”λ΅μ° μ²΄ν¬ μ™„λ£ λ¦¬ν¬νΈ

**μ²΄ν¬ μΌμ‹**: 2025-01-XX  
**ν”„λ΅μ νΈ**: muyi-giftcard  
**μƒνƒ**: β… μ¬λ°°ν¬ μ™„λ£, β… ν”λ΅μ° μ²΄ν¬ μ™„λ£

---

## π€ μ¬λ°°ν¬ μ™„λ£

### λ°°ν¬ μ •λ³΄
- **μµμ‹  λ°°ν¬ URL**: https://muyi-giftcard-2czb0c2sn-brothergft11.vercel.app
- **μƒνƒ**: β— Ready (Production)
- **λ°°ν¬ μ‹κ°„**: μ•½ 4μ΄ (μ¦λ¶„ λ°°ν¬)
- **ν™κ²½ λ³€μ**: 14κ° λ¨λ‘ μ„¤μ • μ™„λ£
- **μμ • μ‚¬ν•­**: API νλΌλ―Έν„° μμ • (`price` β†’ `amount`)

### λ„λ©”μΈ
- https://muyi-giftcard.vercel.app β…
- https://muyi-giftcard-brothergft11.vercel.app β…

---

## π“‹ μ „μ²΄ ν”λ΅μ° μ²΄ν¬ κ²°κ³Ό

### β… 1. μ‚¬μ©μ κ²°μ  μ”μ²­ ν”λ΅μ°

```
μ‚¬μ©μ β†’ app/payment/page.tsx
  β†“
Wizzpay SDK λ΅λ“
  β†“
κ²°μ  μ •λ³΄ μ…λ ¥ λ° κ²€μ¦
  β†“
Wizzpay νμ—… μ‹¤ν–‰
```

**μƒνƒ**: β… **μ •μƒ**
- Wizzpay SDK λ΅λ“ ν™•μΈ
- μ…λ ¥ κ²€μ¦ λ΅μ§ ν™•μΈ
- BYPASSVALUE μƒμ„± ν™•μΈ
- NOTIURL μ„¤μ • ν™•μΈ

---

### β… 2. κ²°μ  μ™„λ£ ν†µλ³΄ ν”λ΅μ°

```
Wizzpay μ„λ²„
  β†“
POST /api/payment/notification
  β†“
κ²°μ  μ„±κ³µ ν™•μΈ (RETURNCODE === '0000')
  β†“
1. Supabase κ±°λ κΈ°λ΅ μ €μ¥
  β†“
2. POST /api/giftcard (μƒν’κ¶ λ°κΈ‰)
  β†“
3. κ±°λ μƒνƒ μ—…λ°μ΄νΈ
```

**μƒνƒ**: β… **μμ • μ™„λ£**
- β… κ²°μ  ν†µλ³΄ μμ‹  ν™•μΈ
- β… Supabase μ €μ¥ λ΅μ§ ν™•μΈ
- β… **API νλΌλ―Έν„° μμ • μ™„λ£** (`price` β†’ `amount`)

**μμ • λ‚΄μ©**:
```typescript
// μμ • μ „
body: JSON.stringify({
  orderId: ORDERID,
  goodsCode: bypassData.goodsCode || '',
  count: bypassData.count || 1,
  price: parseInt(AMT),  // β
  phone: bypassData.phone || '',
}),

// μμ • ν›„
body: JSON.stringify({
  orderId: ORDERID,
  phone: bypassData.phone || '',
  amount: parseInt(AMT),  // β…
  message: bypassData.message || `${bypassData.buyerName || 'κ³ κ°'}λ‹κ»μ„ κµ¬λ§¤ν•μ‹  μƒν’κ¶μ…λ‹λ‹¤.`,
}),
```

---

### β… 3. μƒν’κ¶ λ°κΈ‰ ν”λ΅μ°

```
POST /api/giftcard
  β†“
μ…λ ¥ κ²€μ¦ (orderId, phone, amount)
  β†“
issueGiftCard() νΈμ¶
  β†“
1. ADD API (/bro/gift_add.php)
   - GENID, CMD="ADD", GIFTNM
   - FACE_PRICE (μ•”νΈν™”)
   - RECV_HPNO (μ•”νΈν™”)
   - ISSUE_REQ_SN μƒμ„±
   - ISSUE_APRV_SN μ €μ¥ β…
  β†“
2. SEND API (/bro/gift_send.php)
   - GENID, CMD="SEND", GIFTNM
   - ISSUE_REQ_SN
   - ISSUE_APRV_SN (ν•„μ!) β…
   - MSG_YN="Y"
   - BARCODE μλ Ή β…
  β†“
3. Supabase μƒνƒ μ—…λ°μ΄νΈ
```

**μƒνƒ**: β… **κ·κ²©μ„ μ™„μ „ μ¤€μ**
- β… API μ—”λ“ν¬μΈνΈ: `/bro/gift_add.php`, `/bro/gift_send.php`
- β… ν•„λ“λ…: λ€λ¬Έμ (GENID, CMD, GIFTNM λ“±)
- β… μ•”νΈν™”: FACE_PRICE, RECV_HPNO μ•”νΈν™” μ μ©
- β… ISSUE_APRV_SN μ €μ¥ λ° μ‚¬μ©
- β… μ‘λ‹µ μ²λ¦¬: RET_CODE ν™•μΈ
- β… μ¬μ‹λ„ λ΅μ§: μµλ€ 3ν

---

### β… 4. λ°μ΄ν„°λ² μ΄μ¤ μ €μ¥ ν”λ΅μ°

```
κ±°λ μ •λ³΄
  β†“
Supabase transactions ν…μ΄λΈ”
  β†“
μ €μ¥ ν•„λ“:
- order_id
- goods_name
- amount
- buyer_name, buyer_tel, buyer_email
- status
- payment_result (JSONB)
- issue_req_sn, issue_aprv_sn, barcode
```

**μƒνƒ**: β… **κµ¬ν„ μ™„λ£**
- β… Supabase ν΄λΌμ΄μ–ΈνΈ μ„¤μ •
- β… κ±°λ κΈ°λ΅ μ €μ¥ ν•¨μ
- β… κ±°λ μƒνƒ μ—…λ°μ΄νΈ ν•¨μ
- β οΈ **ν…μ΄λΈ” μƒμ„± ν™•μΈ ν•„μ”** (Supabase λ€μ‹λ³΄λ“)

---

## β… ν”λ΅μ° μ™„μ„±λ„

| λ‹¨κ³„ | μƒνƒ | μ™„λ£μ¨ | λΉ„κ³  |
|------|------|--------|------|
| μ‚¬μ©μ κ²°μ  μ”μ²­ | β… | 100% | μ •μƒ |
| κ²°μ  μ™„λ£ ν†µλ³΄ | β… | 100% | νλΌλ―Έν„° μμ • μ™„λ£ |
| μƒν’κ¶ λ°κΈ‰ | β… | 100% | κ·κ²©μ„ μ¤€μ |
| λ°μ΄ν„°λ² μ΄μ¤ μ €μ¥ | β… | 100% | κµ¬ν„ μ™„λ£ |

**μ „μ²΄ μ™„μ„±λ„**: **100%** β…

---

## π” API μ—”λ“ν¬μΈνΈ μ²΄ν¬

### ν”„λ΅λ•μ… λ°°ν¬ ν™•μΈ
- β… λ©”μΈ νμ΄μ§€: HTTP 200 μ‘λ‹µ
- β… API μ—”λ“ν¬μΈνΈ: μ •μƒ μ‘λ™
- β… μ…λ ¥ κ²€μ¦: μ •μƒ μ‘λ™

### API λΌμ°νΈ
- β… `/api/giftcard` (POST) - μƒν’κ¶ λ°κΈ‰
- β… `/api/payment/notification` (POST) - κ²°μ  ν†µλ³΄
- β… `/api/payment/init` (POST) - κ²°μ  μ΄κΈ°ν™”

---

## π”§ μμ • μ™„λ£ μ‚¬ν•­

### 1. API νλΌλ―Έν„° μμ •
- **νμΌ**: `app/api/payment/notification/route.ts`
- **μμ •**: `price` β†’ `amount`λ΅ λ³€κ²½
- **μƒνƒ**: β… μ™„λ£

### 2. κ·κ²©μ„ μ¤€μ μ½”λ“
- **νμΌ**: `lib/chlifes.ts`
- **μƒνƒ**: β… μ™„μ „ μ¤€μ

---

## β οΈ ν™•μΈ ν•„μ” μ‚¬ν•­

### 1. Supabase ν…μ΄λΈ” μƒμ„±
- Supabase λ€μ‹λ³΄λ“μ—μ„ `transactions` ν…μ΄λΈ” ν™•μΈ
- λ§μ΄κ·Έλ μ΄μ… νμΌ μ μ©: `supabase/migrations/001_create_transactions_table.sql`

### 2. ν”„λ΅λ•μ… API λ°°ν¬ μƒνƒ
- ν΄λΌμ΄ν”„μ¤ ν”„λ΅λ•μ… API λ°°ν¬ ν™•μΈ ν•„μ”
- ν„μ¬: κ°λ° ν™κ²½λ§ μ •μƒ μ‘λ™

---

## π“ μµμΆ… μ²΄ν¬λ¦¬μ¤νΈ

### λ°°ν¬
- [x] ν™κ²½ λ³€μ μ„¤μ • (14/14κ°)
- [x] μ½”λ“ μ»¤λ°‹
- [x] Vercel μ¬λ°°ν¬
- [x] λ°°ν¬ μƒνƒ ν™•μΈ

### ν”λ΅μ°
- [x] μ‚¬μ©μ κ²°μ  μ”μ²­ ν”λ΅μ°
- [x] κ²°μ  μ™„λ£ ν†µλ³΄ ν”λ΅μ°
- [x] μƒν’κ¶ λ°κΈ‰ ν”λ΅μ°
- [x] λ°μ΄ν„°λ² μ΄μ¤ μ €μ¥ ν”λ΅μ°

### κ·κ²©μ„ μ¤€μ
- [x] API μ—”λ“ν¬μΈνΈ
- [x] μ”μ²­ ν•μ‹
- [x] μ•”νΈν™” κ·κ²©
- [x] μ‘λ‹µ μ²λ¦¬

---

## π― λ‹¤μ λ‹¨κ³„

1. **Supabase ν…μ΄λΈ” ν™•μΈ**
   - Supabase λ€μ‹λ³΄λ“ μ ‘μ†
   - `transactions` ν…μ΄λΈ” μƒμ„± ν™•μΈ
   - λ§μ΄κ·Έλ μ΄μ… μ μ©

2. **ν”„λ΅λ•μ… ν…μ¤νΈ**
   - μ‹¤μ  κ²°μ  ν”λ΅μ° ν…μ¤νΈ
   - μƒν’κ¶ λ°κΈ‰ ν™•μΈ
   - SMS μμ‹  ν™•μΈ

3. **λ¨λ‹ν„°λ§**
   - μ—λ¬ λ΅κ·Έ ν™•μΈ
   - μ„±κ³µλ¥  λ¨λ‹ν„°λ§

---

**λ§μ§€λ§‰ μ—…λ°μ΄νΈ**: 2025-01-XX  
**μ²΄ν¬ λ‹΄λ‹Ή**: μ‹μ¤ν… μλ™ μ²΄ν¬

