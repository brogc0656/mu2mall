# 로컬 프록시 서버 실행 가이드

**목적**: 로컬 컴퓨터를 프록시 서버로 사용하여 클라이프스 프로덕션 API 접근

---

## 🚀 빠른 시작 (3단계)

### 1단계: 프록시 서버 실행

```bash
cd /Users/hasanghyeon/brother_site/muyi-giftcard

# 의존성 설치
npm install express cors

# 서버 실행
node proxy-server.js
```

**확인**:
- 브라우저에서 `http://localhost:3001/health` 접속
- `{"status":"ok"}` 응답 확인

---

### 2단계: Cloudflare Tunnel 설정

```bash
# 1. Cloudflare 로그인
cloudflared tunnel login

# 2. 터널 생성
cloudflared tunnel create chlifes-proxy

# 3. 터널 실행 (프록시 서버와 함께)
cloudflared tunnel run chlifes-proxy --url http://localhost:3001
```

**결과**: 
```
+--------------------------------------------------------------------------------------------+
|  Your quick Tunnel has been created! Visit it at (it may take some time to be reachable): |
|  https://xxxx-xxxx-xxxx.trycloudflare.com                                                 |
+--------------------------------------------------------------------------------------------+
```

---

### 3단계: Vercel 환경 변수 설정

```bash
# Vercel 환경 변수 추가
vercel env add CHLIFES_PROXY_URL production
# 값 입력: https://xxxx-xxxx-xxxx.trycloudflare.com/proxy/chlifes
```

---

## 📋 상세 설정

### 방법 A: Cloudflare Tunnel (무료, 추천)

#### 1. Cloudflare 계정 생성
- https://dash.cloudflare.com 접속
- 무료 계정 생성

#### 2. 터널 생성 및 실행

```bash
# 로그인
cloudflared tunnel login

# 터널 생성
cloudflared tunnel create chlifes-proxy

# 터널 실행 (임시 URL)
cloudflared tunnel run chlifes-proxy --url http://localhost:3001
```

**임시 URL 사용**:
- URL이 매번 변경됨
- 테스트용으로 적합

#### 3. 고정 도메인 설정 (선택)

```bash
# 도메인이 있는 경우
cloudflared tunnel route dns chlifes-proxy proxy.yourdomain.com

# 설정 파일 사용
cloudflared tunnel run chlifes-proxy --config cloudflare-tunnel-config.yml
```

---

### 방법 B: ngrok (간단한 임시 해결책)

```bash
# ngrok 설치
brew install ngrok

# ngrok 계정 생성 및 인증
# https://dashboard.ngrok.com/get-started/setup

# 터널 생성
ngrok http 3001
```

**결과**:
```
Forwarding: https://abc123.ngrok.io -> http://localhost:3001
```

---

### 방법 C: 직접 공인 IP 사용 (포트 포워딩 필요)

**현재 공인 IP**: `180.80.147.23`

#### 라우터 포트 포워딩 설정
1. 라우터 관리자 페이지 접속
2. 포트 포워딩 설정:
   - 외부 포트: 3001
   - 내부 IP: 192.168.219.104
   - 내부 포트: 3001
   - 프로토콜: TCP

#### Vercel 환경 변수
```
CHLIFES_PROXY_URL=http://180.80.147.23:3001/proxy/chlifes
```

**주의**: 
- ⚠️ HTTP 사용 (HTTPS 없음)
- ⚠️ 보안 취약
- ⚠️ 공인 IP가 변경될 수 있음

---

## 🔧 코드 수정

### lib/chlifes.ts 수정

```typescript
const CHLIFES_CONFIG = {
  // 프로덕션에서는 프록시 서버 사용
  API_URL: process.env.NODE_ENV === 'production' && process.env.CHLIFES_PROXY_URL
    ? process.env.CHLIFES_PROXY_URL  // 프록시 서버 URL
    : process.env.NEXT_PUBLIC_CHLIFES_URL,  // 개발 환경
  // ...
};
```

---

## 🎯 권장 방법

### 우선순위 1: Cloudflare Tunnel ⭐⭐⭐⭐⭐
- ✅ 무료
- ✅ HTTPS 자동 제공
- ✅ 설정 간단
- ⚠️ 컴퓨터 항상 켜져 있어야 함

### 우선순위 2: ngrok (임시 테스트) ⭐⭐⭐⭐
- ✅ 매우 간단
- ✅ 빠른 테스트
- ⚠️ URL이 매번 변경됨

### 우선순위 3: 직접 공인 IP ⭐⭐
- ✅ 추가 도구 불필요
- ⚠️ 보안 취약
- ⚠️ 포트 포워딩 필요

---

## 📋 실행 스크립트

### start-proxy.sh

```bash
#!/bin/bash

# 프록시 서버 시작
cd /Users/hasanghyeon/brother_site/muyi-giftcard

# PM2로 실행 (자동 재시작)
pm2 start proxy-server.js --name chlifes-proxy

# Cloudflare Tunnel 실행
cloudflared tunnel run chlifes-proxy --url http://localhost:3001
```

---

## ✅ 체크리스트

### 프록시 서버 실행 전
- [ ] Node.js 설치 확인
- [ ] express, cors 패키지 설치
- [ ] 포트 3001 사용 가능 확인

### Cloudflare Tunnel 설정
- [ ] Cloudflare 계정 생성
- [ ] cloudflared 로그인
- [ ] 터널 생성
- [ ] 터널 URL 확인

### Vercel 설정
- [ ] CHLIFES_PROXY_URL 환경 변수 추가
- [ ] 재배포

### 클라이프스 IP 등록
- [ ] 프록시 서버의 공인 IP 확인
- [ ] 클라이프스에 IP 등록 요청
  - IP: 180.80.147.23 (또는 Cloudflare IP)

---

**마지막 업데이트**: 2025-11-09

