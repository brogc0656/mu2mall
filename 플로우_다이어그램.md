# 전체 플로우 다이어그램

**프로젝트**: muyi-giftcard  
**상태**: ✅ 규격서 준수 완료

---

## 🔄 전체 플로우

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 사용자 결제 요청                                          │
│    app/payment/page.tsx                                      │
│    - 상품권 선택 (SSG, GS25, CU, STARBUCKS)                 │
│    - 금액 선택 (10,000원 ~ 100,000원)                        │
│    - 구매자 정보 입력 (이름, 전화번호, 이메일)              │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. Wizzpay 결제 처리                                        │
│    - Wizzpay SDK 로드                                        │
│    - 결제 팝업 실행                                          │
│    - 카드 정보 입력 및 본인 인증                            │
│    - 결제 승인                                               │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   │ 결제 완료 (RETURNCODE: 0000)
                   ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 결제 통보 수신                                           │
│    POST /api/payment/notification                          │
│    - 결제 정보 수신                                          │
│    - Supabase에 거래 기록 저장                               │
│    - 상품권 발급 API 호출                                    │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   │ POST /api/giftcard
                   ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. 상품권 발급 (규격서 준수)                                │
│    lib/chlifes.ts → issueGiftCard()                        │
│                                                              │
│    4-1. ADD API (/bro/gift_add.php)                        │
│         - GENID, CMD="ADD", GIFTNM                          │
│         - FACE_PRICE (암호화)                                │
│         - RECV_HPNO (암호화)                                 │
│         - ISSUE_REQ_SN 생성                                  │
│         - ISSUE_APRV_SN 저장 ← 중요!                        │
│                                                              │
│    4-2. SEND API (/bro/gift_send.php)                      │
│         - GENID, CMD="SEND", GIFTNM                         │
│         - ISSUE_REQ_SN                                       │
│         - ISSUE_APRV_SN (ADD에서 받은 값)                    │
│         - MSG_YN="Y" (클라이프스 SMS 발송)                   │
│         - BARCODE 수령 ✅                                    │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   │ SMS 발송
                   ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. 완료 처리                                                │
│    - Supabase 거래 상태 업데이트                            │
│    - 사용자에게 결과 표시                                    │
│    - 바코드 전달 (SMS + 응답)                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 📋 단계별 상세 플로우

### Step 1: 사용자 결제 요청

**파일**: `app/payment/page.tsx`

```typescript
1. 상품권 선택 (code, price)
2. 금액 선택
3. 구매자 정보 입력
   - buyerName
   - buyerTel (010-1234-5678)
   - buyerEmail
4. 이용약관 동의
5. 결제 버튼 클릭
   ↓
6. Wizzpay SDK 초기화
7. 결제 정보 설정
   - orderId 생성
   - BYPASSVALUE 생성 (goodsCode, phone, buyerName, email)
   - NOTIURL 설정: /api/payment/notification
8. Wizzpay 팝업 실행
```

---

### Step 2: Wizzpay 결제 처리

**외부 서비스**: Wizzpay PG

```
1. 팝업창에서 카드 정보 입력
2. 본인 인증 (ARS/SMS)
3. 결제 승인
4. 결과 반환
   - RETURNCODE: 0000 (성공)
   - TID, ORDERID, AMT 등
```

---

### Step 3: 결제 통보 수신

**파일**: `app/api/payment/notification/route.ts`

```typescript
POST /api/payment/notification
  ↓
1. 결제 정보 파싱
   - RETURNCODE 확인
   - BYPASSVALUE 파싱
  ↓
2. 결제 성공 시 (RETURNCODE === '0000')
   ↓
3. Supabase 거래 기록 저장
   - order_id: ORDERID
   - amount: AMT
   - buyer_name, buyer_tel, buyer_email
   - status: 'completed'
  ↓
4. 상품권 발급 API 호출
   POST /api/giftcard
   {
     orderId: ORDERID,
     phone: bypassData.phone,
     amount: parseInt(AMT),
     message: "..."
   }
  ↓
5. 거래 상태 업데이트
   - 상품권 발급 결과 저장
   - issue_req_sn, issue_aprv_sn, barcode
```

---

### Step 4: 상품권 발급 (규격서 준수)

**파일**: `lib/chlifes.ts`

#### 4-1. ADD API (예비발행)

```typescript
POST https://api.chlifes.co.kr/bro/gift_add.php

요청:
{
  "GENID": "AG20251006211422",
  "CMD": "ADD",
  "GIFTNM": "PR20251006212653",
  "FACE_PRICE": "[암호화된 금액]",
  "ISSUE_REQ_SN": "BRO2025011012345678",
  "RECV_HPNO": "[암호화된 전화번호]",
  "MESSAGE": "상품권입니다",
  "VALID_DAY": "30"
}

응답:
{
  "RET_CODE": "000000",
  "ISSUE_APRV_SN": "510241337334534C",  // ← 저장 필수!
  "ISSUE_REQ_SN": "BRO2025011012345678",
  "VALID_START_DATE": "20250110",
  "VALID_END_DATE": "20250209"
}
```

#### 4-2. SEND API (발행확정)

```typescript
POST https://api.chlifes.co.kr/bro/gift_send.php

요청:
{
  "GENID": "AG20251006211422",
  "CMD": "SEND",
  "GIFTNM": "PR20251006212653",
  "ISSUE_REQ_SN": "BRO2025011012345678",
  "ISSUE_APRV_SN": "510241337334534C",  // ← ADD에서 받은 값
  "MSG_YN": "Y"
}

응답:
{
  "RET_CODE": "000000",
  "BARCODE": "19129569457152",  // ← 상품권 바코드
  "ISSUE_APRV_SN": "510241337334534C"
}
```

---

### Step 5: 완료 처리

**파일**: `app/api/giftcard/route.ts`, `lib/supabase.ts`

```typescript
1. 상품권 발급 성공 확인
   ↓
2. Supabase 거래 상태 업데이트
   {
     issue_req_sn: result.issueReqSn,
     issue_aprv_sn: result.issueAprvSn,
     barcode: result.barcode,
     status: 'completed'
   }
   ↓
3. 응답 반환
   {
     success: true,
     data: {
       issueReqSn: "...",
       barcode: "19129569457152"
     }
   }
   ↓
4. SMS 발송 (클라이프스가 자동 발송)
   - 바코드 포함
   - 메시지 내용
```

---

## 🔐 보안 플로우

### 암호화 처리

```
1. 클라이언트 → 서버
   - 민감 정보는 서버로만 전송
   - Wizzpay 키는 서버 전용
   - Chlifes 키는 서버 전용

2. 서버 → 클라이프스 API
   - FACE_PRICE: AES-256-CBC 암호화
   - RECV_HPNO: AES-256-CBC 암호화
   - MESSAGE: 평문 (규격서)

3. 서버 → Supabase
   - Service Role Key 사용 (서버 전용)
   - 민감 정보는 JSONB로 저장
```

---

## ✅ 플로우 검증 체크리스트

### 정상 플로우
- [x] 사용자 결제 요청 → Wizzpay 팝업
- [x] 결제 완료 → 통보 수신
- [x] 통보 수신 → Supabase 저장
- [x] 통보 수신 → 상품권 발급 API 호출
- [x] 상품권 발급 → ADD API (규격서 준수)
- [x] ADD 성공 → ISSUE_APRV_SN 저장
- [x] 상품권 발급 → SEND API (규격서 준수)
- [x] SEND 성공 → BARCODE 수령
- [x] 완료 → Supabase 상태 업데이트
- [x] 완료 → SMS 발송 (클라이프스)

### 에러 처리
- [x] 결제 실패 → Supabase에 'failed' 저장
- [x] 상품권 발급 실패 → 재시도 (최대 3회)
- [x] 최종 실패 → 'needs_manual_processing' 플래그

---

## 📊 플로우 완성도

| 단계 | 구현 | 규격서 준수 | 테스트 | 상태 |
|------|------|------------|--------|------|
| 결제 요청 | ✅ | N/A | ⏳ | 대기 |
| 결제 처리 | ✅ | N/A | ⏳ | 대기 |
| 결제 통보 | ✅ | ✅ | ⏳ | 대기 |
| 상품권 발급 | ✅ | ✅ | ⏳ | 대기 |
| DB 저장 | ✅ | ✅ | ⏳ | 대기 |

**구현 완료도**: **100%** ✅  
**규격서 준수도**: **100%** ✅  
**테스트 완료도**: **0%** ⏳ (프로덕션 테스트 필요)

---

**마지막 업데이트**: 2025-01-XX

