# ν”λ΅μ° μ²΄ν¬λ¦¬μ¤νΈ

**μ²΄ν¬ μΌμ‹**: 2025-01-XX  
**ν”„λ΅μ νΈ**: muyi-giftcard  
**λ°°ν¬ μƒνƒ**: β… μ¬λ°°ν¬ μ™„λ£

---

## π€ λ°°ν¬ μ •λ³΄

### μµμ‹  λ°°ν¬
- **URL**: https://muyi-giftcard-imzpkuy18-brothergft11.vercel.app
- **μƒνƒ**: β— Ready (Production)
- **λ°°ν¬ μ‹κ°„**: 33μ΄
- **μƒμ„±μΌ**: 2025-11-09 14:45:40 (μ•½ 1λ¶„ μ „)

### λ„λ©”μΈ
- https://muyi-giftcard.vercel.app
- https://muyi-giftcard-brothergft11.vercel.app

---

## π“‹ μ „μ²΄ ν”λ΅μ° μ²΄ν¬

### 1. μ‚¬μ©μ κ²°μ  μ”μ²­ ν”λ΅μ°

```
μ‚¬μ©μ (λΈλΌμ°μ €)
  β†“
app/payment/page.tsx
  β†“
Wizzpay SDK λ΅λ“
  β†“
κ²°μ  μ •λ³΄ μ…λ ¥ (κµ¬λ§¤μλ…, μ „ν™”λ²νΈ, μ΄λ©”μΌ)
  β†“
Wizzpay νμ—… μ‹¤ν–‰
  β†“
μΉ΄λ“ κ²°μ  μ§„ν–‰
```

**μ²΄ν¬ ν•­λ©**:
- β… Wizzpay SDK λ΅λ“ (`wizzauth.js`)
- β… κ²°μ  μ •λ³΄ μ…λ ¥ νΌ
- β… μ…λ ¥ κ²€μ¦ (μ „ν™”λ²νΈ, μ΄λ©”μΌ)
- β… BYPASSVALUE μƒμ„± (goodsCode, phone, buyerName, email)
- β… NOTIURL μ„¤μ •: `/api/payment/notification`

**νμΌ**: `app/payment/page.tsx`

---

### 2. κ²°μ  μ™„λ£ ν†µλ³΄ ν”λ΅μ°

```
Wizzpay μ„λ²„
  β†“
POST /api/payment/notification
  β†“
κ²°μ  μ„±κ³µ ν™•μΈ (RETURNCODE === '0000')
  β†“
1. Supabaseμ— κ±°λ κΈ°λ΅ μ €μ¥
  β†“
2. /api/giftcard νΈμ¶ (μƒν’κ¶ λ°κΈ‰)
  β†“
3. κ±°λ μƒνƒ μ—…λ°μ΄νΈ
```

**μ²΄ν¬ ν•­λ©**:
- β… κ²°μ  ν†µλ³΄ μμ‹  (`app/api/payment/notification/route.ts`)
- β… κ²°μ  μ„±κ³µ ν™•μΈ
- β… Supabase κ±°λ κΈ°λ΅ μ €μ¥
- β οΈ **μƒν’κ¶ λ°κΈ‰ API νΈμ¶** (νλΌλ―Έν„° ν™•μΈ ν•„μ”)

**νμΌ**: `app/api/payment/notification/route.ts`

**β οΈ λ°κ²¬λ λ¬Έμ **:
```typescript
// ν„μ¬ μ½”λ“ (67-73μ¤„)
body: JSON.stringify({
  orderId: ORDERID,
  goodsCode: bypassData.goodsCode || '',  // β μƒλ΅μ΄ APIμ—λ” μ—†μ
  count: bypassData.count || 1,           // β μƒλ΅μ΄ APIμ—λ” μ—†μ
  price: parseInt(AMT),                    // β 'amount'μ—¬μ•Ό ν•¨
  phone: bypassData.phone || '',
}),

// μƒλ΅μ΄ API ν•μ‹ (app/api/giftcard/route.ts)
{
  orderId: string,
  phone: string,
  amount: number,      // 'price'κ°€ μ•„λ‹ 'amount'
  message?: string,
  validDay?: string
}
```

---

### 3. μƒν’κ¶ λ°κΈ‰ ν”λ΅μ°

```
POST /api/giftcard
  β†“
μ…λ ¥ κ²€μ¦ (orderId, phone, amount)
  β†“
issueGiftCard() νΈμ¶
  β†“
1. ADD API (/bro/gift_add.php)
   - FACE_PRICE μ•”νΈν™”
   - RECV_HPNO μ•”νΈν™”
   - ISSUE_REQ_SN μƒμ„±
   - ISSUE_APRV_SN μ €μ¥
  β†“
2. SEND API (/bro/gift_send.php)
   - ISSUE_APRV_SN μ‚¬μ©
   - BARCODE μλ Ή
  β†“
3. Supabase κ±°λ μƒνƒ μ—…λ°μ΄νΈ
  β†“
μ‘λ‹µ λ°ν™
```

**μ²΄ν¬ ν•­λ©**:
- β… API λΌμ°νΈ κµ¬ν„ (`app/api/giftcard/route.ts`)
- β… μ…λ ¥ κ²€μ¦
- β… κ·κ²©μ„ μ¤€μ (μ—”λ“ν¬μΈνΈ, ν•„λ“λ…, μ•”νΈν™”)
- β… μ¬μ‹λ„ λ΅μ§ (μµλ€ 3ν)
- β… Supabase μƒνƒ μ—…λ°μ΄νΈ

**νμΌ**: 
- `app/api/giftcard/route.ts`
- `lib/chlifes.ts`

---

### 4. λ°μ΄ν„°λ² μ΄μ¤ μ €μ¥ ν”λ΅μ°

```
κ±°λ μ •λ³΄
  β†“
Supabase transactions ν…μ΄λΈ”
  β†“
ν•„λ“:
- order_id (Wizzpay ORDERID)
- goods_name
- amount
- buyer_name, buyer_tel, buyer_email
- status (pending/completed/failed)
- payment_result (JSONB)
- issue_req_sn, issue_aprv_sn, barcode
```

**μ²΄ν¬ ν•­λ©**:
- β… Supabase ν΄λΌμ΄μ–ΈνΈ μ„¤μ •
- β… κ±°λ κΈ°λ΅ μ €μ¥ ν•¨μ
- β… κ±°λ μƒνƒ μ—…λ°μ΄νΈ ν•¨μ
- β οΈ **ν…μ΄λΈ” μƒμ„± ν™•μΈ ν•„μ”**

**νμΌ**: 
- `lib/supabase.ts`
- `supabase/migrations/001_create_transactions_table.sql`

---

## β οΈ λ°κ²¬λ λ¬Έμ μ 

### 1. API νλΌλ―Έν„° λ¶μΌμΉ (μ¤‘μ”)

**λ¬Έμ **: `app/api/payment/notification/route.ts`μ—μ„ `/api/giftcard` νΈμ¶ μ‹ νλΌλ―Έν„°κ°€ μƒλ΅μ΄ API ν•μ‹κ³Ό λ§μ§€ μ•μ

**ν„μ¬ μ½”λ“**:
```typescript
body: JSON.stringify({
  orderId: ORDERID,
  goodsCode: bypassData.goodsCode || '',  // β μ‚¬μ©λμ§€ μ•μ
  count: bypassData.count || 1,         // β μ‚¬μ©λμ§€ μ•μ
  price: parseInt(AMT),                  // β 'amount'μ—¬μ•Ό ν•¨
  phone: bypassData.phone || '',
}),
```

**μμ • ν•„μ”**:
```typescript
body: JSON.stringify({
  orderId: ORDERID,
  phone: bypassData.phone || '',
  amount: parseInt(AMT),  // 'price' β†’ 'amount'
  message: bypassData.message || `${bypassData.buyerName}λ‹κ»μ„ κµ¬λ§¤ν•μ‹  μƒν’κ¶μ…λ‹λ‹¤.`,
}),
```

---

## β… μ •μƒ μ‘λ™ ν™•μΈ

### 1. ν™κ²½ λ³€μ
- β… 14κ° ν™κ²½ λ³€μ λ¨λ‘ μ„¤μ • μ™„λ£
- β… Production ν™κ²½μ— μ μ©λ¨

### 2. API μ—”λ“ν¬μΈνΈ
- β… `/api/giftcard` (POST) - μƒν’κ¶ λ°κΈ‰
- β… `/api/payment/notification` (POST) - κ²°μ  ν†µλ³΄
- β… `/api/payment/init` (POST) - κ²°μ  μ΄κΈ°ν™”

### 3. κ·κ²©μ„ μ¤€μ
- β… API μ—”λ“ν¬μΈνΈ: `/bro/gift_add.php`, `/bro/gift_send.php`
- β… ν•„λ“λ…: λ€λ¬Έμ (GENID, CMD, GIFTNM λ“±)
- β… μ•”νΈν™”: FACE_PRICE, RECV_HPNO
- β… μ‘λ‹µ μ²λ¦¬: RET_CODE ν™•μΈ

---

## π”§ μ¦‰μ‹ μμ • ν•„μ”

### μ°μ„ μμ„ 1: API νλΌλ―Έν„° μμ •

`app/api/payment/notification/route.ts` νμΌ μμ •:

```typescript
// 67-73μ¤„ μμ •
body: JSON.stringify({
  orderId: ORDERID,
  phone: bypassData.phone || '',
  amount: parseInt(AMT),  // 'price' β†’ 'amount'λ΅ λ³€κ²½
  message: bypassData.message || `${bypassData.buyerName}λ‹κ»μ„ κµ¬λ§¤ν•μ‹  μƒν’κ¶μ…λ‹λ‹¤.`,
}),
```

---

## π“ ν”λ΅μ° μ™„μ„±λ„

| λ‹¨κ³„ | μƒνƒ | μ™„λ£μ¨ |
|------|------|--------|
| μ‚¬μ©μ κ²°μ  μ”μ²­ | β… | 100% |
| κ²°μ  μ™„λ£ ν†µλ³΄ | β οΈ | 90% (νλΌλ―Έν„° μμ • ν•„μ”) |
| μƒν’κ¶ λ°κΈ‰ | β… | 100% |
| λ°μ΄ν„°λ² μ΄μ¤ μ €μ¥ | β οΈ | 90% (ν…μ΄λΈ” ν™•μΈ ν•„μ”) |

**μ „μ²΄ μ™„μ„±λ„**: **95%**

---

## β… λ‹¤μ λ‹¨κ³„

1. **API νλΌλ―Έν„° μμ •** (μ°μ„ μμ„ 1)
   - `app/api/payment/notification/route.ts` μμ •
   - μ¬λ°°ν¬

2. **Supabase ν…μ΄λΈ” ν™•μΈ**
   - Supabase λ€μ‹λ³΄λ“μ—μ„ `transactions` ν…μ΄λΈ” μƒμ„± ν™•μΈ
   - λ§μ΄κ·Έλ μ΄μ… νμΌ μ μ©

3. **ν”„λ΅λ•μ… ν…μ¤νΈ**
   - μ‹¤μ  κ²°μ  ν”λ΅μ° ν…μ¤νΈ
   - μƒν’κ¶ λ°κΈ‰ ν™•μΈ
   - λ°μ΄ν„°λ² μ΄μ¤ μ €μ¥ ν™•μΈ

---

**λ§μ§€λ§‰ μ—…λ°μ΄νΈ**: 2025-01-XX

